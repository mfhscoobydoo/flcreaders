<!DOCTYPE html>
<html>
  <head>
    <title>Family Readers</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400" rel="stylesheet">
    <script src="futurePress/epub.js"></script>
    <script src="futurePress/zip.min.js"></script>
    <script src="futurePress/jszip.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="p5/p5.min.js"></script>
    <script src="AudioPlayer/dist/howler.js"></script>
    <script src="p5/addons/p5.dom.min.js"></script>
    <script src="p5/addons/p5.sound.min.js"></script>
    <script src="Hammer/hammer.js"></script>
    <script src="record.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body onload="record();">
    <script>
    // cookie functions
    function setCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        document.cookie = name+'=; Max-Age=-99999999;';
    }

    var set_number = getCookie("set_number") || 1;
    var book_number = getCookie("book_number") || 1;
    var currentChapterHref = getCookie("currentChapterHref") || "Book_"+set_number+"-"+book_number+"-1.xhtml";
    var sound = new Howl({
      src: ["DATA/Audio/Converted/FEMMAX.mp3"]
    });

    function updateWords(){
      var url = "https://fonts.googleapis.com/css?family=Poppins:300,400";
      var page = (rendition.location.start.href.replace('.xhtml','').split('-').slice(-1)[0]-1);
      $('iframe').contents().find('head').append($('<link/>',{rel:'stylesheet',href:url, type:'text/css'}));
      $('iframe').contents().find('span').click(function(){playAudio($(this).text()); });
      $('iframe').contents().find('span').css("font-family", "Poppins").css("cursor","pointer").css("user-select","none");
      if(page<1){
        $('.playPage').hide();
      }else{
        $('.playPage').show();
      }
      currentChapterHref = rendition.location.start.href
      setCookie("currentChapterHref",currentChapterHref);
    }

    function filterWord(s){
      return s.replace(/[^\w]|_/g, "").toUpperCase();
    }
    function playAudio(unfilteredWord=''){
      var word = filterWord(unfilteredWord);
        $.ajax({
            url:"DATA/Audio/Converted/"+"MALE"+word+".mp3",
            type:'HEAD',
            error: function()
            {
              //file not exists
              $.ajax({
                  url:"DATA/Audio/Converted/"+"FEM"+word+".mp3",
                  type:'HEAD',
                  error: function()
                  {
                    //file not exists
                    sound = new Howl({
                      src: ["DATA/Audio/Converted/"+"X"+word+".mp3"]
                    });
                    sound.play();
                  },
                  success: function()
                  {
                    //file exists
                    sound = new Howl({
                      src: ["DATA/Audio/Converted/"+"FEM"+word+".mp3"]
                    });
                    sound.play();
                  }
              });
            },
            success: function()
            {
              //file exists
              var Gender = Math.floor((Math.random() * 100) + 1);
              if (Gender > 50){
                sound = new Howl({
                  src: ["DATA/Audio/Converted/"+"FEM"+word+".mp3"]
                });
                sound.play();
              }else {
                sound = new Howl({
                  src: ["DATA/Audio/Converted/"+"MALE"+word+".mp3"]
                });
                sound.play();
              }
            }
        });
    }
    function playPage(){
      var page = (rendition.location.start.href.replace('.xhtml','').split('-').slice(-1)[0]-1);
      var sound = new Howl({
        src: ["DATA/Audio/Converted2/"+set_number+"-"+book_number+"-"+page+".mp3"]
      });
      sound.play();
    }
    </script>
    <div class="mobile-shown">
      <div class="landscape-alert w3-card w3-light-grey w3-round-large">
        <p class="alert-text">
          Please turn your device on it's side, or resize the window.
        </p>
      </div>
    </div>
    <div class="sidebar" id="sidebar">
      <a href="http://flcinc.org"><p class="back-button"><img src="DATA/Images/backArrow.svg" id="backArrow"> Back to flcinc.org</p></a>
      <div class="menuContainer">
        <img src="DATA/Images/menu.svg" class="menu" onclick="hideNav()">
        <p class="center">Table of Contents</p>
      </div>
        <ul class="units">
          <li>
            <button onclick="Nav('Set1')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
              Set 1
            </button>
            <div id="Set1" class="w3-hide w3-container">
              <ul class="units">
                <li class="w3-button w3-card w3-round w3-hover-blue" id="1_1">Max</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="1_2">Max Ran</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="1_3">The Bag</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="1_4">The Tan Cab</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="1_5">The Map</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="1_6">Razz</li>
              </ul>
            </div>
          </li>
          <li>
            <button onclick="Nav('Set2')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
              Set 2
            </button>
            <div id="Set2" class="w3-hide w3-container">
              <ul class="units">
                <li class="w3-button w3-card w3-round w3-hover-blue" id="2_1">Kim</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="2_2">The Kit</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="2_3">The Big Pit</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="2_4">The Tin Lid</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="2_5">Fizz Mix</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="2_6">Fizz In The Pit</li>
              </ul>
            </div>
          </li>
            <li>
              <button onclick="Nav('Set3')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
                Set 3
              </button>
              <div id="Set3" class="w3-hide w3-container">
                <ul class="units">
                  <li class="w3-button w3-card w3-round w3-hover-blue" id="3_1">Max's Box</li>
                  <li class="w3-button w3-card w3-round w3-hover-blue" id="3_2">The Bon-Bon Box</li>
                  <li class="w3-button w3-card w3-round w3-hover-blue" id="3_3">The Box Mix</li>
                  <li class="w3-button w3-card w3-round w3-hover-blue" id="3_4">Mom and Dad Hop-Jig</li>
                  <li class="w3-button w3-card w3-round w3-hover-blue" id="3_5">On TV</li>
                  <li class="w3-button w3-card w3-round w3-hover-blue" id="3_6">The TV Box</li>
                </ul>
              </div>
            </li>
          <li>
            <button onclick="Nav('Set4')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
              Set 4
            </button>
            <div id="Set4" class="w3-hide w3-container">
              <ul class="units">
                <li class="w3-button w3-card w3-round w3-hover-blue" id="4_1">Kim's Bug</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="4_2">Max's Hum-Bug</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="4_3">Fizz Mud</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="4_4">The Sub</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="4_5">The Whiz-Kid</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="4_6">The Tub</li>
              </ul>
            </div>
          </li>
          <li>
            <button onclick="Nav('Set5')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
              Set 5
            </button>
            <div id="Set5" class="w3-hide w3-container">
              <ul class="units">
                <li class="w3-button w3-card w3-round w3-hover-blue" id="5_1">A Red Hen</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="5_2">Ben Has a Pet</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="5_3">Ten In a Hut</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="5_4">Hen Pox</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="5_5">Ben in Bed</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="5_6">Ben Will Get Well</li>
              </ul>
            </div>
          </li>
          <li>
            <button onclick="Nav('Set6')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
              Set 6
            </button>
            <div id="Set6" class="w3-hide w3-container">
              <ul class="units">
                <li class="w3-button w3-card w3-round w3-hover-blue" id="6_1">The Red Rock Dock</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="6_2">Tuff-Tug</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="6_3">The Hop</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="6_4">Tuff-Tug Tips</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="6_5">The Quiz is 1</li>
                <li class="w3-button w3-card w3-round w3-hover-blue" id="6_6">The Quiz is 2</li>
              </ul>
            </div>
          </li>
        <li>
          <button onclick="Nav('Set7')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
            Set 7
          </button>
          <div id="Set7" class="w3-hide w3-container">
            <ul class="units">
              <li class="w3-button w3-card w3-round w3-hover-blue" id="7_1">The Silent "e"</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="7_2">The Big Hole</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="7_3">The Fumes</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="7_4">Pete's Bike Ride</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="7_5">The Lemonade Sale</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="7_6">The Gal Pals</li>
            </ul>
          </div>
        </li>
        <li>
          <button onclick="Nav('Set8')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
            Set 8
          </button>
          <div id="Set8" class="w3-hide w3-container">
            <ul class="units">
              <li class="w3-button w3-card w3-round w3-hover-blue" id="8_1">Max is Six</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="8_2">The Cake</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="8_3">The Rope</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="8_4">Oak Hill Ranch</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="8_5">Time To Ride</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="8_6">The Picnic</li>
            </ul>
          </div>
        </li>
        <li>
          <button onclick="Nav('Set9')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
            Set 9
          </button>
          <div id="Set9" class="w3-hide w3-container">
            <ul class="units">
              <li class="w3-button w3-card w3-round w3-hover-blue" id="9_1">Miss Vie</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="9_2">The Time Box</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="9_3">The Haircut</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="9_4">The Big Deal</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="9_5">The Quiz is 3</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="9_6">Me and the Bee</li>
            </ul>
          </div>
        </li>
        <li>
          <button onclick="Nav('Set10')" class="set-button w3-button w3-block w3-center-align button w3-hover-blue">
            Set 10
          </button>
          <div id="Set10" class="w3-hide w3-container">
            <ul class="units">
              <li class="w3-button w3-card w3-round w3-hover-blue" id="10_1">Boe E. Toad</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="10_2">Number Fun</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="10_3">The Neat Game</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="10_4">Max the Grand</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="10_5">The Prize</li>
              <li class="w3-button w3-card w3-round w3-hover-blue" id="10_6">A Nifty Ball </li>
            </ul>
          </div>
        </li>
      </ul>
    </div>
    <div class="content w3-display-container">
      <div onclick="rendition.prev();" class="pagenav w3-button w3-card w3-round w3-hover-blue w3-display-left"><img src="DATA/Images/arrowLeft.svg" class="arrows"></div>
      <div id="area" class="w3-block w3-card w3-round w3-display-middle">
        <div id="loading">
          <img src="DATA/Images/loadingImage.svg" id="loadingImage">
        </div>
      </div>
      <div class="swipeArea" id="swipeArea">

      </div>
      <div onclick="rendition.next();" class="pagenav w3-button w3-card w3-round w3-hover-blue w3-display-right"><img src="DATA/Images/arrowRight.svg" class="arrows"></div>
      <div class="record" id="record-button" onclick="record()">
        <p id="Record">Loading...</p>
      </div>
      <div class="playPage w3-round-xlarge w3-blue w3-hover-teal w3-card" onclick="playPage()" style="display:none;">
        <p id="playPage">Play Page</p>
      </div>
    </div>
    <script>
          "use strict";
          var book = ePub("DATA/Readers/Set"+set_number+"/"+book_number+"/"+"OEBPS/content.opf");
          //DATA/Readers/Set"+set_number+"/"+book_number+"-/"+book_number+"/"+"OEBPS/content.opf
          //DATA/Readers/Set"+set_number+"/"+book_number+"/"+"OEBPS/content.opf
          //DATA/Readers/Set"+set_number+"/"+book_number+".epub
          //DATA/Readers/Set1/1-/1/OEBPS/content.opf
          var rendition = book.renderTo("area", {width: "100%", height:"100%", flow: "paginated", minSpreadWidth: "none"});
          rendition.display();
          rendition.on('relocated', function(location){
            updateWords();
          });

          document.getElementById("Set"+set_number).className += " w3-show";

          $('#Set1 li, #Set2 li, #Set3 li, #Set4 li, #Set5 li, #Set6 li, #Set7 li, #Set8 li, #Set9 li, #Set10 li').each( function (index) {
            $(this).on("click", function(e){
              set_number = e.target.id.split('_')[0];
              book_number = e.target.id.split('_')[1];
              setCookie("set_number", set_number);
              setCookie("book_number", book_number);
              var bookPath = "DATA/Readers/Set"+set_number+"/"+book_number+"/"+"OEBPS/content.opf";
              currentChapterHref = "Book_"+set_number+"-"+book_number+"-1.xhtml";
              setCookie("currentChapterHref",currentChapterHref);
              //alert(bookPath);
              book.destroy();
              book = ePub(bookPath);
              rendition = book.renderTo("area", {width: "100%", height:"100%", flow: "paginated", minSpreadWidth: "none"});
              rendition.display();
              rendition.on('relocated', function(location){
                updateWords();
              });

              //book.goto(currentChapterHref);
            });
          });
          /*
            window.addEventListener("orientationchange", doOnOrientationChange, false);
            function doOnOrientationChange(){
              var bookPath = "DATA/Readers/Set"+set_number+"/"+book_number+".epub";
              book = ePub(bookPath);
              var rendition = book.renderTo("area", {width: "100%", height:"100%", flow: "paginated"});
              var displayed = rendition.display();
              book.on('rendition:pageChanged', function(location){
                updateWords();
              });
            }
            */
      </script>
      <script>
        function Nav(id) {
          var x = document.getElementById(id);
          if (x.className.indexOf("w3-show") == -1) {
            x.className += " w3-show";
          } else {
            x.className = x.className.replace(" w3-show", "");
          }
        }
        rendition.display(currentChapterHref);
        function hideNav() {
          var x = document.getElementById("sidebar");
          if (x.className.indexOf("w3-show") == -1) {
            x.className += " w3-show";
          } else {
            x.className = x.className.replace(" w3-show", "");
          }
        }
</script>
  </body>
</html>
